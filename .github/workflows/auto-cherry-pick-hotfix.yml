name: Auto Cherry-Pick Hotfix to Develop

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  cherry-pick:
    runs-on: ubuntu-latest
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for cherry-pick

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch develop branch
        run: git fetch origin develop

      - name: Identify last merged hotfix commit
        id: find_hotfix
        run: |
          # Find the latest merge commit on main with "hotfix/" in its message
          merge_commit=$(git log main --merges -n 1 --grep="hotfix/" --pretty=format:"%H" || true)

          if [ -z "$merge_commit" ]; then
            echo "No recent hotfix merge found â€” skipping cherry-pick."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found hotfix merge commit: $merge_commit"
          echo "found=true" >> $GITHUB_OUTPUT
          echo "merge_commit=$merge_commit" >> $GITHUB_OUTPUT

      - name: Stop if no hotfix merge found
        if: steps.find_hotfix.outputs.found == 'false'
        run: echo "No hotfix merge detected, skipping workflow."

      - name: Get PR details for merge commit
        if: steps.find_hotfix.outputs.found == 'true'
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = '${{ steps.find_hotfix.outputs.merge_commit }}';
            const res = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: sha,
            });
            const pr = res.data && res.data[0];
            const number = pr ? pr.number : '';
            const title = pr ? pr.title || '' : '';
            const body = pr ? pr.body || '' : '';
            const url = pr ? pr.html_url || '' : '';
            core.setOutput('number', number);
            core.setOutput('title', title);
            core.setOutput('body_json', JSON.stringify(body));
            core.setOutput('url', url);

      - name: Notify Slack (bot) PR merged
        if: ${{ steps.find_hotfix.outputs.found == 'true' && env.SLACK_BOT_TOKEN != '' && env.SLACK_CHANNEL_ID != '' }}
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "ðŸŽ‰ Hotfix PR merged to main",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸŽ‰ *PR merged successfully!*\nRepository: *${{ github.repository }}*\nPR: <${{ steps.get_pr.outputs.url }}|view PR>\nNumber: #${{ steps.get_pr.outputs.number }}\nActor: *${{ github.actor }}*\n\n*Well done you champ, I can't believe you did this, you rock!!!*"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ steps.get_pr.outputs.body_json }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}

      - name: Cherry-pick hotfix merge into develop
        if: steps.find_hotfix.outputs.found == 'true'
        id: cherry_pick
        run: |
          merge_commit=${{ steps.find_hotfix.outputs.merge_commit }}

          # Checkout develop branch
          git checkout develop

          # Try to cherry-pick the merge commit
          echo "Cherry-picking merge commit $merge_commit into develop..."
          if ! git cherry-pick -m 1 $merge_commit; then
            echo "::error::Cherry-pick conflict detected for commit $merge_commit."
            git cherry-pick --abort
            echo "conflict=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "conflict=false" >> $GITHUB_OUTPUT

      - name: Push changes to develop
        if: steps.cherry_pick.outputs.conflict == 'false'
        run: |
          git push origin develop
          echo "âœ… Successfully cherry-picked hotfix into develop!"

      # Slack notifications via Slack App (bot token)
      - name: Notify Slack (bot) on success
        if: ${{ success() && steps.find_hotfix.outputs.found == 'true' && env.SLACK_BOT_TOKEN != '' && env.SLACK_CHANNEL_ID != '' }}
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "âœ… Hotfix cherry-picked to develop",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Cherry-pick completed successfully.*\nRepository: *${{ github.repository }}*\nFrom: `main`\nTo: `develop`\nCommit: <https://github.com/${{ github.repository }}/commit/${{ steps.find_hotfix.outputs.merge_commit }}|${{ steps.find_hotfix.outputs.merge_commit }}>\nActor: *${{ github.actor }}*"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}

      - name: Notify Slack (bot) on conflict
        if: ${{ failure() && env.SLACK_BOT_TOKEN != '' && env.SLACK_CHANNEL_ID != '' }}
        uses: slackapi/slack-github-action@v1.27.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": ":warning: Cherry-pick conflict detected",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *Cherry-pick failed while merging a hotfix into `develop`.*\nRepository: *${{ github.repository }}*\nCommit: <https://github.com/${{ github.repository }}/commit/${{ steps.find_hotfix.outputs.merge_commit }}|${{ steps.find_hotfix.outputs.merge_commit }}>\nActor: *${{ github.actor }}*\n\nManual intervention is required."
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ env.SLACK_BOT_TOKEN }}